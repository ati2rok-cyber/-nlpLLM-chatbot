#!/usr/bin/env python3

import os
import json
import streamlit as st
from groq import Groq
from dotenv import load_dotenv

# ‡πÇ‡∏´‡∏•‡∏î environment variables ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .env
load_dotenv(".env")
GROQ_API_KEY = os.getenv("GROQ_API_KEY")
client = Groq(api_key=GROQ_API_KEY)

def chatboot(question):
    system_prompt = """
Cancer Pain Management Chatbot
language: "Thai"

role: |
  ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á
  ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å:
  - PainAD (5 ‡∏°‡∏¥‡∏ï‡∏¥: ‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à, ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á, ‡∏™‡∏µ‡∏´‡∏ô‡πâ‡∏≤, ‡∏†‡∏≤‡∏©‡∏≤‡∏Å‡∏≤‡∏¢, ‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏≠‡∏ö‡πÇ‡∏¢‡∏ô)
  - Edmonton Classification System for Cancer Pain (ECS-CP: Mechanism, Incident, Psychological, Social)
  - WHO 3-step guideline ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î

instruction: |
  - ‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: No pain / Mild / Moderate / Severe / Incident pain / Psychological factor / Social factor
  - ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á WHO ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏ö‡∏ó
  - ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏°‡∏≤
  - ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 3 ‡∏™‡πà‡∏ß‡∏ô: 
    1) ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î 
    2) ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ 
    3) ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô ‡πÜ
  - ‡∏´‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤:
    "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô"
  - ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (no hallucination)
  - ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å guideline

output_format: |
  ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: [No pain / Mild / Moderate / Severe / Incident pain / Psychological factor / Social factor]
  ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ï‡∏≤‡∏° WHO guideline]
  ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ criteria ‡πÑ‡∏´‡∏ô]

examples:

- Input: "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏´‡∏≠‡∏ö ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏≤‡∏á ‡∏™‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏π‡∏î‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß ‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏¥‡πà‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≠‡∏ö‡∏ö‡πà‡∏≠‡∏¢ ‡πÜ"
  Output:
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: Severe pain
    ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ opioid ‡∏ï‡∏≤‡∏° WHO ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3 ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: PainAD ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏•‡∏≤‡∏¢‡∏°‡∏¥‡∏ï‡∏¥‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á

- Input: "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏ß‡∏î ‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏™‡∏ö‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≠‡∏ö"
  Output:
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: No pain
    ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏ó‡∏∏‡∏Å‡∏°‡∏¥‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥

- Input: "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ñ‡∏≠‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡∏ö‡πà‡∏ô‡∏õ‡∏ß‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏™‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏¢‡∏¥‡πâ‡∏°‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ"
  Output:
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: Mild pain
    ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ non-opioid ‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏≤‡∏£‡∏≤‡πÄ‡∏ã‡∏ï‡∏≤‡∏°‡∏≠‡∏• ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏ô 2 ‡∏°‡∏¥‡∏ï‡∏¥

- Input: "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏∏‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á"
  Output:
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: Incident pain
    ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏õ‡∏ß‡∏î‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö movement

- Input: "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡∏ö‡πà‡∏≠‡∏¢ ‡∏ñ‡∏∂‡∏á‡πÅ‡∏°‡πâ‡∏õ‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å"
  Output:
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: Psychological factor
    ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏¥‡∏ï‡πÉ‡∏à
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏à‡∏¥‡∏ï‡πÉ‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏° perception ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î

- Input: "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á"
  Output:
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: Social factor
    ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÅ‡∏Å‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠ pain control

- Input: "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÅ‡∏£‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÜ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≤‡∏á ‡∏™‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏â‡∏¢"
  Output:
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: Mild pain
    ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ non-opioid ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢

- Input: "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏¢‡∏Å‡∏°‡∏∑‡∏≠‡∏Å‡∏∏‡∏°‡∏ó‡πâ‡∏≠‡∏á‡∏ö‡πà‡∏≠‡∏¢ ‡∏™‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏∂‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡πÑ‡∏î‡πâ"
  Output:
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: Moderate pain
    ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡πÄ‡∏£‡∏¥‡πà‡∏° opioid ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡πà‡∏≥‡∏ï‡∏≤‡∏° WHO ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: Body language + facial expression ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô

- Input: "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏¥‡πâ‡∏ô‡πÑ‡∏õ‡∏°‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ô‡∏à‡∏±‡∏ö‡πÑ‡∏ß‡πâ"
  Output:
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: Severe pain
    ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡πÉ‡∏´‡πâ opioid ‡∏ï‡∏≤‡∏° WHO ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3 ‡πÅ‡∏•‡∏∞‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: Vocalization + agitation ‡∏™‡∏π‡∏á

- Input: "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏¢‡∏¥‡πâ‡∏° ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡πà‡∏ô"
  Output:
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î: No pain
    ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏õ‡∏ß‡∏î

    Schema:
{
  "pain_level": "No pain | Mild pain | Moderate pain | Severe pain | Incident pain | Psychological factor | Social factor",
  "management": "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏° WHO guideline",
  "reason": "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏≤‡∏° PainAD/ECS-CP",
  "mechanism": "‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏ ‡πÄ‡∏ä‡πà‡∏ô Neuropathic, Nociceptive, Mixed",
  "incident_pain": "‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ",
  "psychological": "‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ",
  "social": "‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ"
}

‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ schema ‡∏ô‡∏µ‡πâ
‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö:
{
  "pain_level": "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏",
  "management": "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô",
  "reason": "Out of scope",
  "mechanism": "",
  "incident_pain": "",
  "psychological": "",
  "social": ""
}
"""

    response = client.chat.completions.create(
        model="llama-3.1-8b-instant",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": question},
        ],
        temperature=0.2,
        max_tokens=2048,
    )
    return response.choices[0].message.content.strip()


def main():
    # üñºÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ò‡∏µ‡∏°‡∏™‡∏µ
    st.set_page_config(page_title="AI Cancer Pain Care Bot", page_icon="üíä", layout="wide")
    st.markdown("""
        <style>
        body { background-color: #000000; }
        .stForm { background-color: #1a1a1a; padding: 2rem; border-radius: 12px; color: #ffffff; }
        </style>
    """, unsafe_allow_html=True)

    st.title("üíä ‡πÅ‡∏ä‡∏ï‡∏ö‡∏≠‡∏ï‡∏î‡∏π‡πÅ‡∏•‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á")
    st.subheader("‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏ï‡∏≤‡∏° PainAD & ECS-CP")

    # üßæ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
    if "messages" not in st.session_state:
        st.session_state["messages"] = [
            {"role": "assistant", "content": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏â‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ 5 ‡∏°‡∏¥‡∏ï‡∏¥‡∏Ñ‡πà‡∏∞ üíä"}
        ]

    with st.form("chat_form"):
        query = st.text_input("üó£Ô∏è ‡∏Ñ‡∏∏‡∏ì:", placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î ‡∏™‡∏µ‡∏´‡∏ô‡πâ‡∏≤ ‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡∏Å...").strip()
        submitted = st.form_submit_button("üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°")

        if submitted and query:
            answer = chatboot(query)
            st.session_state["messages"].append({"role": "user", "content": query})
            st.session_state["messages"].append({"role": "assistant", "content": answer})
        elif submitted and not query:
            st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á")

    # üß† ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ä‡∏ï‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ JSON
    for msg in st.session_state["messages"]:
        if msg["role"] == "user":
            st.markdown(f"**üßë‚Äç‚öïÔ∏è ‡∏Ñ‡∏∏‡∏ì:** {msg['content']}")
        else:
            try:
                data = json.loads(msg["content"])
                with st.container():
                    st.markdown("#### ü§ñ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î")
                    col1, col2 = st.columns(2)
                    col1.metric("‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î", data.get("pain_level", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"))
                    col1.metric("‡∏Å‡∏•‡πÑ‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î (Mechanism)", data.get("mechanism", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"))
                    col2.metric("Incident Pain", data.get("incident_pain", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"))
                    col2.metric("‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏à‡∏¥‡∏ï‡πÉ‡∏à (Psychological)", data.get("psychological", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"))
                    st.metric("‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏™‡∏±‡∏á‡∏Ñ‡∏° (Social)", data.get("social", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"))
                    st.info(data.get("reason", ""))
            except Exception:
                st.markdown(f"**ü§ñ ‡∏ö‡∏≠‡∏ó:** {msg['content']}")

if __name__ == "__main__":
    main()
